<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Expense Tracker</title>
<link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>üí∞ Expense Tracker</h1>
			<div class="user-info">
				<span class="user-name">Welcome, <span
					th:text="${#authentication.principal.username}">User</span>!
				</span>
				<form th:action="@{/logout}" method="post" style="display: inline;">
					<button type="submit" class="logout-btn">Logout</button>
				</form>
			</div>
		</div>

		<div class="stats-grid">
			<div class="stat-card income">
				<h3>Total Income</h3>
				<div class="stat-value"
					th:text="'$' + ${#numbers.formatDecimal(totalIncome, 1, 2)}">$0.00</div>
			</div>
			<div class="stat-card expense">
				<h3>Total Expenses</h3>
				<div class="stat-value"
					th:text="'$' + ${#numbers.formatDecimal(totalExpenses, 1, 2)}">$0.00</div>
			</div>
			<div class="stat-card balance">
				<h3>Balance</h3>
				<div class="stat-value"
					th:text="'$' + ${#numbers.formatDecimal(balance, 1, 2)}">$0.00</div>
			</div>
		</div>

		<div class="main-content">
			<div class="card">
				<div class="add-transaction-bar">
					<button class="add-btn" onclick="openTransactionModal()">‚ûï Add Transaction</button>
				</div>

				<h2>Recent Transactions</h2>

				<!-- Filters Section -->
				<div class="filters-section">
					<form method="get" action="/dashboard" class="filters-form">
						<div class="filter-group">
							<input type="text" name="search"
								placeholder="üîç Search description..." class="filter-input"
								th:value="${param.search}">
						</div>

						<div class="filter-group">
							<select name="type" class="filter-select">
								<option value="">All Types</option>
								<option value="INCOME" th:selected="${param.type == 'INCOME'}">Income</option>
								<option value="EXPENSE" th:selected="${param.type == 'EXPENSE'}">Expense</option>
							</select>
						</div>

						<div class="filter-group">
							<select name="category" class="filter-select">
								<option value="">All Categories</option>
								<option th:each="cat : ${categories}" th:value="${cat}"
									th:text="${cat.displayName}"
									th:selected="${param.category == cat.name()}">Category</option>
							</select>
						</div>

						<div class="filter-group">
							<select name="period" class="filter-select"
								onchange="toggleCustomDates(this.value)">
								<option value="">All Time</option>
								<option value="today" th:selected="${param.period == 'today'}">Today</option>
								<option value="this_week"
									th:selected="${param.period == 'this_week'}">This Week</option>
								<option value="this_month"
									th:selected="${param.period == 'this_month'}">This Month</option>
								<option value="last_month"
									th:selected="${param.period == 'last_month'}">Last Month</option>
								<option value="custom" th:selected="${param.period == 'custom'}">Custom Range</option>
							</select>
						</div>

						<div id="customDates" class="custom-dates" style="display: none;">
							<input type="date" name="startDate" class="filter-input"
								th:value="${param.startDate}"> <span>to</span> 
							<input type="date" name="endDate" class="filter-input"
								th:value="${param.endDate}">
						</div>

						<div class="filter-actions">
							<button type="submit" class="filter-btn">Apply Filters</button>
							<a href="/dashboard" class="clear-btn">Clear</a>
						</div>
					</form>
				</div>

				<!-- Transactions List -->
				<div class="transactions-list">
					<div th:if="${expenses.isEmpty()}" class="empty-state">
						<svg fill="#999" viewBox="0 0 24 24">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-7-2h2v-4h4v-2h-4V7h-2v4H7v2h5z" />
                        </svg>
						<p>No transactions found. Try adjusting your filters or add a new transaction!</p>
					</div>

					<div th:if="${!expenses.isEmpty()}">
						<div th:each="exp : ${expenses}" class="transaction-item">
							<div class="transaction-info">
								<div class="transaction-description" th:text="${exp.description}">Description</div>
								<div class="transaction-details">
									<span class="transaction-category" th:text="${exp.category.displayName}">Category</span> 
									<span class="transaction-date" th:text="${#temporals.format(exp.date, 'MMM dd, yyyy')}">Date</span>
								</div>
								<div th:if="${exp.notes != null && !exp.notes.isEmpty()}"
									class="transaction-notes" th:text="${exp.notes}">Notes</div>
							</div>
							<div class="transaction-actions">
								<div class="transaction-amount"
									th:classappend="${exp.type.name() == 'INCOME'} ? 'income' : 'expense'"
									th:text="${exp.type.name() == 'INCOME' ? '+' : '-'} + '$' + ${#numbers.formatDecimal(exp.amount, 1, 2)}">
									$0.00</div>
								<div class="action-buttons">
									<!-- EDIT BUTTON with data attributes -->
									<button type="button" 
									        class="edit-btn"
									        onclick="openEditModal(this)"
									        th:data-id="${exp.id}"
									        th:data-description="${exp.description}"
									        th:data-amount="${exp.amount}"
									        th:data-type="${exp.type}"
									        th:data-category="${exp.category}"
									        th:data-date="${exp.date}"
									        th:data-notes="${exp.notes}">
										Edit
									</button>

									<!-- DELETE BUTTON -->
									<form th:action="@{/expense/delete/{id}(id=${exp.id})}"
										method="post" style="display: inline;">
										    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
										
										<button type="submit" class="delete-btn"
											onclick="return confirm('Are you sure you want to delete this transaction?')">
											Delete
										</button>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	</div>

	<!-- Transaction Modal (Add/Edit) -->
	<div id="transactionModal" class="modal">
		<div class="modal-content">
			<span class="close" onclick="closeTransactionModal()">&times;</span>
			<h2 id="modalTitle">Add Transaction</h2>
			<form id="transactionForm" action="/expense/add" method="post">
			    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
			
				<input type="hidden" id="expenseId" name="id">
				
				<div class="form-group">
					<label>Description</label> 
					<input type="text" id="description" name="description" required>
				</div>
				
				<div class="form-group">
					<label>Amount</label> 
					<input type="number" id="amount" name="amount" step="0.01" required>
				</div>
				
				<div class="form-group">
					<label>Type</label> 
					<select id="type" name="type" required>
						<option value="">Select Type</option>
						<option value="INCOME">Income</option>
						<option value="EXPENSE">Expense</option>
					</select>
				</div>
				
				<div class="form-group">
					<label>Category</label> 
					<select id="category" name="category" required>
						<option value="">Select Category</option>
						<option th:each="cat : ${categories}" 
						        th:value="${cat}"
							    th:text="${cat.displayName}"></option>
					</select>
				</div>
				
				<div class="form-group">
					<label>Date</label> 
					<input type="date" id="modalDate" name="date" required>
				</div>
				
				<div class="form-group">
					<label>Notes</label>
					<textarea id="notes" name="notes"></textarea>
				</div>
				
				<button type="submit" class="btn">Save Transaction</button>
			</form>
		</div>
		
		
	</div>
	<!-- ================= VISUAL REPORTS ================= -->
<div class="reports-section">

    <h2>üìä Visual Reports</h2>

    <div class="reports-grid">

        <div class="report-card">
            <h3>Expenses by Category</h3>
            <canvas id="categoryChart"></canvas>
        </div>

        <div class="report-card">
            <h3>Income vs Expenses</h3>
            <canvas id="incomeExpenseChart"></canvas>
        </div>

        <div class="report-card report-card-wide">
            <h3>Monthly Trend</h3>
            <canvas id="monthlyTrendChart"></canvas>
        </div>

        <div class="report-card report-card-wide">
            <h3>Last 30 Days Activity</h3>
            <canvas id="dailyChart"></canvas>
        </div>

    </div>
</div>
<!-- ================================================= -->
	
	
<!-- 1Ô∏è‚É£ Thymeleaf ‚Üí JS data -->
<script th:inline="javascript">
    const expensesData = /*[[${expenses}]]*/ [];
</script>

<!-- 2Ô∏è‚É£ Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- 3Ô∏è‚É£ Your chart logic -->
<script th:src="@{/js/charts.js}"></script>

<!-- 4Ô∏è‚É£ Initialize charts -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        initializeCharts(expensesData);
    });
</script>

	<script>
    document.addEventListener('DOMContentLoaded', function () {
        const periodSelect = document.querySelector('select[name="period"]');
        if (periodSelect && periodSelect.value === 'custom') {
            document.getElementById('customDates').style.display = 'flex';
        }
    });

    function toggleCustomDates(value) {
        const customDates = document.getElementById('customDates');
        customDates.style.display = value === 'custom' ? 'flex' : 'none';
    }

    /* =========================a
       ADD MODE
    ========================= */
    function openTransactionModal() {
        const modal = document.getElementById('transactionModal');
        const form = document.getElementById('transactionForm');

        document.getElementById('modalTitle').innerText = '‚ûï Add Transaction';
        
        // Reset form and set action for adding
        form.reset();
        form.action = '/expense/add';
        
        // Set today's date
        document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];

        modal.style.display = 'flex';
    }

    /* =========================
       EDIT MODE
    ========================= */
    function openEditModal(button) {
        const modal = document.getElementById('transactionModal');
        const form = document.getElementById('transactionForm');

        document.getElementById('modalTitle').innerText = '‚úèÔ∏è Edit Transaction';
        
        // Get data from button's data attributes
        const id = button.getAttribute('data-id');
        const description = button.getAttribute('data-description');
        const amount = button.getAttribute('data-amount');
        const type = button.getAttribute('data-type');
        const category = button.getAttribute('data-category');
        const date = button.getAttribute('data-date');
        const notes = button.getAttribute('data-notes');
        
        // Set form action for updating
        form.action = '/expense/update/' + id;
        
        // Populate form fields
        document.getElementById('description').value = description;
        document.getElementById('amount').value = amount;
        document.getElementById('type').value = type;
        document.getElementById('category').value = category;
        document.getElementById('modalDate').value = date;
        document.getElementById('notes').value = notes || '';

        modal.style.display = 'flex';
    }

    function closeTransactionModal() {
        document.getElementById('transactionModal').style.display = 'none';
    }

    window.onclick = function (event) {
        const modal = document.getElementById('transactionModal');
        if (event.target === modal) {
            closeTransactionModal();
        }
    };
	</script>
</body>
</html>